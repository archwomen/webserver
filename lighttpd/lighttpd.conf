## This is a minimal example config
## See /usr/share/doc/lighttpd
## and http://redmine.lighttpd.net/projects/lighttpd/wiki/Docs:ConfigurationOptions

## To Debug this config file, use the following commands
# lighttpd -D -f /etc/lighttpd/lighttpd.conf # run as daemon
# lighttpd -t -f /etc/lighttpd/lighttpd.conf # test config and exit
# lighttpd -p -f /etc/lighttpd/lighttpd.conf # show config parse tree and exit

include "conf.d/mimetypes.conf"

## Server Modules ##

# mod_simple_vhost must be first 
# mod_fastcgi must be after mod_rewrite and mod_access
# mod_accesslog must be after mod_fastcgi

server.modules = ( "mod_simple_vhost",
                   "mod_rewrite",
                   "mod_access",
                   "mod_fastcgi",
                   "mod_cgi",
                   "mod_accesslog",
                   "mod_expire",
                   "mod_alias",
                   "mod_auth",
                   "mod_status",
                   "mod_compress",
                   "mod_magnet",
                   "mod_redirect",
                   "mod_proxy" )

server.port              = 80
server.username          = "http"
server.groupname         = "http"
server.errorlog          = "/var/log/lighttpd/error.log"
accesslog.filename       = "/var/log/lighttpd/access.log"

## Server Web Root and vhost config ##

# Directory Structure should be as follows:
#
# /srv/http/domain.tld/public
# /srv/http/sub.domain.tld/public
#
# Each subdomain needs A records pointing to the IP address, or CNAME records
# pointing to the top level domain

server.document-root       = "/srv/www"
simple-vhost.server-root   = "/srv/http/"
simple-vhost.default-host  = "archwomen.org"
simple-vhost.document-root = "public"

## Default Files to Serve ##

index-file.names = ( "index.html", "default.html",
                     "index.php",  "default.php",
                     "index.pl",   "default.pl",
                     "index.rb",   "default.rb" )

## Web Directory Listing ##

dir-listing.activate         = "enable"
dir-listing.hide-dotfiles    = "enable"
dir-listing.show-header      = "enable"
dir-listing.hide-header-file = "enable"
dir-listing.set-footer       = "Arch Linux running Lighttpd"
dir-listing.exclude          = ( " *.css " )
dir-listing.show-readme      = "enable"
dir-listing.hide-readme-file = "enable"
#dir-listing.external-css    = ( "/path/to/filelist.css" )

## File compression for faster static content serving ##

compress.cache-dir = "/tmp/lighttpd"
compress.filetype  = ( "text/plain",
                       "text/html",
                       "text/css",
                       "text/xml",
                       "text/javascript" )

## PHP fastcgi configuration, requires the php and php-cgi packages ##

fastcgi.server = ( ".php" => (( "bin-path"              => "/usr/bin/php-cgi", 
                                "socket"                => "/var/run/lighttpd/php.socket",
                                "max-procs"             => 2,
                                "bin-environment"       => ( "PHP_FCGI_CHILDREN"     => "10",
                                                             "PHP_FCGI_MAX_REQUESTS" => "10000" ),
                                "bin-copy-environment"  => ( "PATH", "SHELL", "USER" ),
                                "broken-scriptfilename" => "enable" ))
                 )

## Perl , requires that perl be installed ##

cgi.assign = (".pl"  => "/usr/bin/perl",
              ".cgi" => "/usr/bin/perl")


## Access Lighttpd Status page - Localhost only
#
# You can use an ssh tunnel to access the status page
# ssh -l <remote username> -L 8000:localhost:80 archwomen.org
#
# In a browser on your local machine, go to http://localhost:8000/status

$HTTP["remoteip"] == "127.0.0.1/8" {
    status.status-url = "/status"
}

# SSL configuration for archwomen.org

$SERVER["socket"] == "198.74.62.52:443" {
    ssl.engine               = "enable"
    ssl.pemfile              = "/etc/lighttpd/ssl/archwomen.org.pem"
    ssl.ca-file              = "/etc/ssl/local/RapidSSL_CA_bundle.pem"
    
    # Static files aliased to archwomen.org/media
    alias.url  = ("/media"      => "/srv/http/archwomen.org/media/"      )
    alias.url += ("/news"       => "/srv/http/archwomen.org/news/"       )
    alias.url += ("/calendar"   => "/srv/http/archwomen.org/calendar"    )
    alias.url += ("/blog"       => "/srv/http/archwomen.org/blog/public" )

    # Use local browser cache for static content
    expire.url = ("/media/" => "access plus 7 days" )

    # User web directories aliased to archwomen.org/user
    alias.url += ("/~meskarune" => "/home/meskarune/public/"  )
    alias.url += ("/~tigrmesh"  => "/home/tigrmesh/public/"   )
    alias.url += ("/~fsckd"     => "/home/fsckdaemon/public/" )
    alias.url += ("/~yar"       => "/home/yar/public/"        )
    alias.url += ("/~vodik"     => "/home/vodik/public/"      )

    # Do not serve hidden (dot) files
    $HTTP["url"] !~ "^/~" { # except user web dirs
    $HTTP["url"] =~ "/\." { # all dot files
        #access.deny-all = "enable" # lighttpd >= 1.5
        url.access-deny = ("") # lighttpd < 1.5
        }
        }
    
    server.document-root        = "/srv/http/archwomen.org/public/"
}

## Redirect www.archwomen.org to archwomenn.org
#
#$HTTP["host"] =~ "^www\.(.*)" {
#    url.redirect = ( "^/(.*)" => "http://%1/$1" )
#}

# Vhost configuration for archwomen.org

$HTTP["host"] =~ "archwomen.org" {

    # Redmine
    url.rewrite-once += ( "^/redmine(/favicon.ico)" => "$1" ) # capture favicon
    $HTTP["url"] =~ "^/redmine" {
        proxy.server = ("" => (("host" => "127.0.0.1", "port" => 3999)))
    }

    # Static files aliased to archwomen.org/media
    alias.url  = ("/media"      => "/srv/http/archwomen.org/media/"      )
    alias.url += ("/news"       => "/srv/http/archwomen.org/news/"       )
    alias.url += ("/calendar"   => "/srv/http/archwomen.org/calendar"    )
    alias.url += ("/blog"       => "/srv/http/archwomen.org/blog/public" )

    # Use local browser cache for static content
    expire.url = ("/media/" => "access plus 7 days" )
    
    # User web directories aliased to archowmen.org/user
    alias.url += ("/~meskarune" => "/home/meskarune/public/"  )
    alias.url += ("/~tigrmesh"  => "/home/tigrmesh/public/"   )
    alias.url += ("/~fsckd"     => "/home/fsckdaemon/public/" )
    alias.url += ("/~yar"       => "/home/yar/public/"        )
    alias.url += ("/~vodik"     => "/home/vodik/public/"      )

    # Do not serve hidden (dot) files
    $HTTP["url"] !~ "^/~" { # except user web dirs
    $HTTP["url"] =~ "/\." { # all dot files
        #access.deny-all = "enable" # lighttpd >= 1.5
        url.access-deny = ("") # lighttpd < 1.5
    }
    }
    
    # Document-root
    server.document-root        = "/srv/http/archwomen.org/public/"
    
}

# Vhost configuration for redmine.archwomen.org

$HTTP["host"] == "redmine.archwomen.org" {
    url.redirect = ( "^/(.*)" => "https://archwomen.org/redmine/$1" )
}
