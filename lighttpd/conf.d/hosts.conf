## This is the configuration for web hosts ##

# Access the Lighttpd status page - localhost only
#
# Your can use an ssh tunnel to access the status page
# ssh -l <remote username> -L 8000:localhost:80 archwomen.org
# 
# In a browser on your local machine, go to "http://localhost:8000/status"

$HTTP["remoteip"] == "127.0.0.1/8" {
    status.status-url = "/status"
}

# Local Host Only Applications 
$HTTP["host"] == "localhost" {
    server.document-root = "/srv/http/localhost/public/"
    alias.url = ("/sqlbuddy"   => "/srv/http/localhost/sqlbuddy/")
}
## SSL Configuration for Archwomen.org ##

$SERVER["socket"] == "archwomen.org:443" {
    ssl.engine  = "enable"
    ssl.pemfile = "/etc/lighttpd/ssl/archwomen.org.pem"
    ssl.ca-file = "/etc/ssl/local/RapidSSL_CA_bundle.pem"
    ssl.cipher-list = "ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-RC4-SHA:ECDHE-RSA-RC4-SHA:ECDH-ECDSA-RC4-SHA:ECDH-RSA-RC4-SHA:ECDHE-RSA-AES256-SHA:RC4-SHA"
}

## URL aliases for sub-directories ##

alias.url  = ("/media"          =>  "/srv/http/archwomen.org/media/"         )
alias.url += ("/news"           =>  "/srv/http/archwomen.org/news/"          )
alias.url += ("/calendar"       =>  "/srv/http/archwomen.org/calendar/"      )
alias.url += ("/blog"           =>  "/srv/http/archwomen.org/blog/public/"   )
alias.url += ("/test"           =>  "/srv/http/archwomen.org/test/"          )
alias.url += ("/stats"          =>  "/srv/http/archwomen.org/stats/public"   )
#alias.url += ("/wiki"           =>  "/srv/http/archwomen.org/wiki/public"    )
alias.url += ("/projectmanager" =>  "/srv/http/archwomen.org/projectmanager" )
alias.url += ("/cgi-bin"        =>  "/srv/http/archwomen.org/cgi-bin"        )

# Use local browser cache for static content
$HTTP["url"] =~ "^/media/" {
    expire.url = ( "" => "access plus 7 days" )
}
$HTTP["url"] =~ "^/assets" {
    expire.url = ("" => "access plus 7 days")
}

# Set CORS for ArchMap
$HTTP["url"] =~ "^/media/archmap/" {
    setenv.add-response-header += ( "Access-Control-Allow-Origin" => "*" )
}

# User web directories aliased to archwomen.org/user
alias.url += ("/~meskarune" => "/home/meskarune/public/"  )
alias.url += ("/~tigrmesh"  => "/home/tigrmesh/public/"   )
alias.url += ("/~fsckd"     => "/home/fsckdaemon/public/" )
alias.url += ("/~yar"       => "/home/yar/public/"        )
alias.url += ("/~vodik"     => "/home/vodik/public/"      )

# Do not serve hidden (dot) files
$HTTP["url"] !~ "^/~" { # except user web dirs
    $HTTP["url"] =~ "/\." { # all dot files
        url.access-deny = ("")
    }
}

## Dokuwiki ##

# the wiki is accessible via https://archwomen.org/wiki/
var.dokudir = "/wiki"

# deny access completly to these
$HTTP["url"] =~ "/(\.|_)ht" { url.access-deny = ( "" ) }
$HTTP["url"] =~ "^" + var.dokudir + "/(bin|data|inc|conf)/"  { url.access-deny = ( "" ) }

# make URLs pretty
$HTTP["url"] =~ "^" + var.dokudir { index-file.names = ("doku.php") }
url.rewrite = ( 
    "^" + var.dokudir + "/lib/.*$"              => "$0",
    "^" + var.dokudir + "/_media/(.*)?\?(.*)$"  => var.dokudir + "/lib/exe/fetch.php?media=$1&$2",
    "^" + var.dokudir + "/_media/(.*)$"         => var.dokudir + "/lib/exe/fetch.php?media=$1",
    "^" + var.dokudir + "/_detail/(.*)?\?(.*)$" => var.dokudir + "/lib/exe/detail.php?media=$1&$2",
    "^" + var.dokudir + "/_detail/(.*)?$"       => var.dokudir + "/lib/exe/detail.php?media=$1",
    "^" + var.dokudir + "/_export/([^/]+)/(.*)\?(.*)$" => var.dokudir + "/doku.php?do=export_$1&id=$2&$3",
    "^" + var.dokudir + "/_export/([^/]+)/(.*)" => var.dokudir + "/doku.php?do=export_$1&id=$2",
    "^" + var.dokudir + "/doku.php.*"           => "$0",
    "^" + var.dokudir + "/feed.php.*"           => "$0",
    "^" + var.dokudir + "/(.*)\?(.*)"           => var.dokudir + "/doku.php?id=$1&$2",
    "^" + var.dokudir + "/(.*)"                 => var.dokudir + "/doku.php?id=$1"
)

# the files are not in document root
alias.url += (var.dokudir => "/srv/http/archwomen.org/dokuwiki/")

## Redmine Configuration ##

#url.rewrite-once += ( "^/redmine(/favicon.ico)" => "$1" ) # capture favicon
#$HTTP["url"] =~ "^/redmine" {
#    proxy.server = ("" => (("host" => "127.0.0.1", "port" => 3999)))
#}
